<!DOCTYPE html>
<html>
<head>
  <title>Grove Guardian Tree Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"/>
  <style>
    html,body {margin:0;padding:0;height:100%;}
    #map {width:100%;height:100%;}
    
    /* Styles for watering slider */
    .watering-slider-container {
      margin-top: 10px;
      margin-bottom: 4px;
    }
    
    .slider-label {
      color: #666;
      font-size: 0.9em;
      display: block;
      margin-bottom: 6px;
    }
    
    .slider-wrapper {
      position: relative;
      height: 20px;
      background: #e3f2fd;
      border-radius: 10px;
      overflow: hidden;
      margin: 6px 0;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .watering-slider {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 20px;
      background: transparent;
      outline: none;
      margin: 0;
      position: relative;
      z-index: 2;
    }
    
    .slider-fill {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg,
        #2196f3 0%,
        #64b5f6 50%,
        #2196f3 100%
      );
      background-size: 200% 100%;
      border-radius: 10px;
      transition: width 0.1s ease;
      animation: waterFlow 2s linear infinite;
      z-index: 1;
      box-shadow: 0 0 10px rgba(33, 150, 243, 0.3);
    }
    
    @keyframes waterFlow {
      0% {
        background-position: 100% 0;
      }
      100% {
        background-position: -100% 0;
      }
    }
    
    /* Webkit (Chrome, Safari) */
    .watering-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #fff;
      border: 2px solid #2196f3;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      margin-top: -4px;
      position: relative;
      z-index: 3;
      transition: transform 0.2s ease;
    }
    
    .watering-slider::-webkit-slider-thumb:hover {
      transform: scale(1.1);
    }
    
    /* Firefox */
    .watering-slider::-moz-range-thumb {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #fff;
      border: 2px solid #2196f3;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      position: relative;
      z-index: 3;
      transition: transform 0.2s ease;
    }
    
    .watering-slider::-moz-range-thumb:hover {
      transform: scale(1.1);
    }
    
    .confirmation-text {
      color: #2196f3;
      font-weight: bold;
      margin: 4px 0 2px;
      opacity: 0;
      transition: opacity 0.3s;
      height: 20px;
    }
    
    .confirmation-text.visible {
      opacity: 1;
    }
    
    .last-watered {
      font-size: 0.9em;
      color: #666;
      margin-top: 5px;
    }

    /* Ripple effect for successful update */
    @keyframes ripple {
      0% {
        box-shadow: 0 0 0 0 rgba(33, 150, 243, 0.3);
      }
      100% {
        box-shadow: 0 0 0 20px rgba(33, 150, 243, 0);
      }
    }

    .slider-success .slider-fill {
      animation: ripple 1s ease-out;
    }

    /* Back to Home Button Styles */
    .home-button {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      background: white;
      border: none;
      border-radius: 12px;
      padding: 12px 20px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: sans-serif;
      font-size: 16px;
      color: #673ab7;
      transition: all 0.3s ease;
      overflow: hidden;
    }

    .home-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(
        45deg,
        rgba(103, 58, 183, 0.1),
        rgba(103, 58, 183, 0.05)
      );
      transform: scaleX(0);
      transform-origin: right;
      transition: transform 0.3s ease;
    }

    .home-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(103, 58, 183, 0.2);
    }

    .home-button:hover::before {
      transform: scaleX(1);
      transform-origin: left;
    }

    .home-button .material-icons {
      font-size: 24px;
      transition: transform 0.3s ease;
    }

    .home-button:hover .material-icons {
      transform: translateX(-4px);
    }

    .home-button .tree-icon {
      position: absolute;
      right: -24px;
      opacity: 0;
      transition: all 0.3s ease;
      color: #81c784;
    }

    .home-button:hover .tree-icon {
      right: 16px;
      opacity: 1;
    }

    @media (max-width: 768px) {
      .home-button {
        top: 10px;
        right: 10px;
        padding: 8px 16px;
        font-size: 14px;
      }
    }

    /* Tree marker styles */
    .leaflet-marker-icon {
      filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.2));
    }

    /* Custom tree marker */
    .tree-marker {
      width: 24px;
      height: 24px;
      position: relative;
    }

    /* Yellow halo for favorited trees */
    .tree-dot.favorited {
        stroke: #1b5e20, rgba(255, 215, 0, 0.6);
        stroke-width: 2px, 5px;
        stroke-opacity: 1, 0.6;
    }

    /* Base tree dot styles */
    .tree-dot {
        filter: drop-shadow(0 1px 1px rgba(0, 0, 0, 0.2));
        cursor: pointer;
    }

    /* Popup styles */
    .popup-title strong {
      font-size: 1.1em;
      display: inline-block;
      margin-bottom: 2px;
    }

    .popup-title {
      flex-grow: 1;
    }

    .popup-heart {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s ease;
    }

    .popup-heart:hover {
      transform: scale(1.1);
    }

    .popup-heart:active {
      transform: scale(0.9);
    }

    /* Increase clickable area with padding */
    .leaflet-interactive.tree-dot {
      padding: 10px !important;
      margin: -10px !important;
    }
    
    .tree-trunk {
      transform: translateY(6px);
      pointer-events: none;  /* Ensure trunk doesn't interfere with clicking */
    }

    /* Highlight animation for selected tree */
    @keyframes highlightPulse {
      0% {
        box-shadow: 0 0 0 0 rgba(255, 235, 59, 0.7);
      }
      70% {
        box-shadow: 0 0 0 15px rgba(255, 235, 59, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(255, 235, 59, 0);
      }
    }

    .highlight-marker {
      animation: highlightPulse 0.75s ease-out 3;
    }

    /* Water droplet icon styles */
    .water-droplet {
        color: #2196f3;
        font-size: 24px;
        filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.2));
        text-shadow: 0 0 2px white, 0 0 2px white, 0 0 2px white, 0 0 2px white;
    }

    /* Coordinate display styles - disabled */
    #coordinate-display {
        display: none !important;
    }

    #coordinate-toggle {
        display: none !important;
    }
  </style>
</head>
<body>
<button onclick="window.location.href='index.html'" class="home-button">
  <span class="material-icons">arrow_back</span>
  Back to Home
</button>
<div id="map"></div>
<div id="coordinate-display">Click anywhere to see coordinates</div>
<button id="coordinate-toggle">
    <span class="material-icons">add_location</span>
    Toggle Coordinate Mode
</button>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
import { auth, db, signInAnonymously } from './firebase-init.js';
import { doc, updateDoc, Timestamp, collection, getDocs } from 'https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js';

// Define getMyGrove in global scope
window.getMyGrove = function() {
    const cookie = document.cookie.split('; ').find(row => row.startsWith('myGrove='));
    if (cookie) {
        try {
            return JSON.parse(cookie.split('=')[1]);
        } catch (e) {
            return [];
        }
    }
    return [];
};

const mapW=1277, mapH=934; // Dimensions for no-trees-map.png
const map = L.map('map', { 
  crs: L.CRS.Simple, 
  minZoom: -0.5,
  maxZoom: 4, 
  zoomSnap: 0.25,
  zoomDelta: 0.25,
  wheelPxPerZoomLevel: 120,
  maxBounds: [[0,0], [mapH,mapW]],
  maxBoundsViscosity: 0.8,
  // Add settings to control pan behavior
  bounceAtZoomLimits: false,
  // Disable animations to prevent recursion
  zoomAnimation: false,
  fadeAnimation: false,
  markerZoomAnimation: false
});
const bounds = [[0,0],[mapH,mapW]];
L.imageOverlay('no-trees-map.png', bounds).addTo(map);
map.fitBounds(bounds);  // Use fitBounds instead of setView

// Function to ensure coordinates are within bounds
function constrainToBounds(latlng) {
    return [
        Math.max(0, Math.min(mapH, latlng[0])),
        Math.max(0, Math.min(mapW, latlng[1]))
    ];
}

// Function to format date
function formatDate(date) {
  if (!date) return 'Never';
  if (date.toDate) date = date.toDate(); // Handle Firestore Timestamp
  return new Date(date).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
}

// Function to update watering status
async function updateTreeWatering(treeId) {
  try {
    const treeRef = doc(db, "trees", treeId);
    await updateDoc(treeRef, {
      lastWateredDate: Timestamp.now()
    });
    return true;
  } catch (error) {
    console.error("Error updating tree watering:", error);
    return false;
  }
}

// Check for tree parameter in URL
const urlParams = new URLSearchParams(window.location.search);
const selectedTreeId = urlParams.get('treeId') || urlParams.get('tree');
let selectedMarker = null;

// Wait for map to be ready and fetch tree data
map.whenReady(async () => {
  try {
    const treesSnapshot = await getDocs(collection(db, "trees"));
    
    treesSnapshot.forEach(doc => {
      const tree = doc.data();
      const treeId = doc.id;
      const latlng = constrainToBounds([tree.mapCoordinates.y, tree.mapCoordinates.x]);
      
      // Check if tree is in grove before creating popup content
      const myGrove = window.getMyGrove();
      const isInGrove = myGrove.includes(treeId);
      
      const popupContent = document.createElement('div');
      popupContent.innerHTML = `
        <div class="popup-title">
          <strong>${tree.commonName || 'Tree'}</strong><br/>
          Scientific name: ${tree.botanicalName || '–'}<br/>
        </div>
        <div style="display: flex; align-items: center; gap: 8px; margin: 8px 0;">
          <div class="last-watered">Last watered: <span id="last-watered-${treeId}">${formatDate(tree.lastWateredDate)}</span></div>
          <button 
            class="popup-heart" 
            id="grove-btn-${treeId}" 
            onclick="toggleGroveTree('${treeId}', this)"
            title="${isInGrove ? 'Remove from My Grove' : 'Add to My Grove'}">
            <span class="material-icons" style="color: ${isInGrove ? '#e53935' : '#4CAF50'}; font-size: 20px;">
              ${isInGrove ? 'favorite' : 'favorite_border'}
            </span>
          </button>
        </div>
        <div class="watering-slider-container">
          <span class="slider-label">Slide to confirm watering</span>
          <div class="slider-wrapper">
            <div class="slider-fill" id="slider-fill-${treeId}"></div>
            <input type="range" class="watering-slider" id="slider-${treeId}" 
                   min="0" max="100" value="0">
          </div>
          <div class="confirmation-text" id="confirm-text-${treeId}">
            Release to confirm watering
          </div>
        </div>
      `;

      const marker = L.circleMarker(latlng, {
        radius: 12,
        color: '#1b5e20',
        weight: 2,
        fillColor: '#43a047',
        fillOpacity: 0.9,
        className: 'tree-dot',
        interactive: true
      })
      .bindPopup(popupContent, {
        autoPan: false,  // Disable automatic panning
        keepInView: false,  // Disable keep in view
        autoPanPadding: [50, 50]
      })
      .addTo(map);

      // Store marker reference in a map for easy access
      window.treeMarkers = window.treeMarkers || new Map();
      window.treeMarkers.set(treeId, marker);

      // If this is the selected tree, store its marker and open popup
      if (treeId === selectedTreeId) {
        selectedMarker = marker;
        map.setView(latlng, 1);
        marker.openPopup();
      }

      // Set initial favorite state
      if (isInGrove) {
        // Add yellow circle behind the tree marker
        L.circleMarker(latlng, {
          radius: 14,
          color: 'rgba(255, 215, 0, 0.6)',
          weight: 5,
          fillOpacity: 0,
          className: 'favorite-halo',
          interactive: false,
          pane: 'markerPane'  // Ensure proper layering
        }).addTo(map);
        
        marker.getElement().classList.add('favorited');
      }

      // Update icon if tree is in grove
      marker.on('popupopen', () => {
        const btn = document.getElementById(`grove-btn-${treeId}`);
        const icon = btn.querySelector('.material-icons');
        const currentGrove = window.getMyGrove(); // Get fresh grove state
        
        if (currentGrove.includes(treeId)) {
          icon.textContent = 'favorite';
          icon.style.color = '#e53935';
        } else {
          icon.textContent = 'favorite_border';
          icon.style.color = '#4CAF50';
        }

        const slider = document.getElementById(`slider-${treeId}`);
        const sliderFill = document.getElementById(`slider-fill-${treeId}`);
        const confirmText = document.getElementById(`confirm-text-${treeId}`);
        let isUpdating = false;
        let success = false;

        slider.addEventListener('input', (e) => {
          const value = parseInt(e.target.value);
          sliderFill.style.width = `${value}%`;
          confirmText.classList.toggle('visible', value > 90);
        });

        slider.addEventListener('change', async (e) => {
          const value = parseInt(e.target.value);
          if (value > 90 && !isUpdating) {
            isUpdating = true;
            confirmText.textContent = 'Updating...';
            
            success = await updateTreeWatering(treeId);
            
            if (success) {
              const lastWateredSpan = document.getElementById(`last-watered-${treeId}`);
              lastWateredSpan.textContent = formatDate(new Date());
              confirmText.textContent = 'Updated!';
              sliderFill.parentElement.classList.add('slider-success');
              setTimeout(() => {
                marker.closePopup();
              }, 1500);
            } else {
              confirmText.textContent = 'Error - Try Again';
            }
          }
          // Always return to start unless update was successful
          if (!isUpdating || !success) {
            slider.value = 0;
            sliderFill.style.width = '0%';
            confirmText.classList.remove('visible');
          }
          isUpdating = false;
        });

        // Reset slider when popup opens
        slider.value = 0;
        sliderFill.style.width = '0%';
        confirmText.classList.remove('visible');
      });

      // Add a small brown trunk dot underneath
      L.circleMarker(latlng, {
        radius: 4,  // Slightly larger trunk
        color: '#3e2723',  // Darker brown
        weight: 0,
        fillColor: '#3e2723',
        fillOpacity: 0.9,
        className: 'tree-trunk',
        offset: [2, 2],
        interactive: false
      }).addTo(map);

      // Add a subtle leaf highlight
      L.circleMarker(latlng, {
        radius: 6,
        color: '#66bb6a',  // Light green
        weight: 0,
        fillColor: '#66bb6a',
        fillOpacity: 0.4,
        className: 'tree-highlight',
        offset: [-2, -2],
        interactive: false
      }).addTo(map);

      // Add custom popup handling
      marker.on('click', function(e) {
        const pos = map.project(e.target.getLatLng());
        const size = map.getSize();
        
        // Only pan if the popup would be off screen
        if (pos.y < 100 || pos.y > size.y - 100 || pos.x < 100 || pos.x > size.x - 100) {
          map.setView(e.target.getLatLng(), map.getZoom(), {
            animate: false  // Disable animation for the pan
          });
        }
      });
    });

    // Add static hose locations
    const hoseLocations = [
        [692.06, 413.96],
        [620.08, 367.97],
        [561.09, 678.94],
        [512.10, 626.95],
        [403.12, 713.94],
        [371.13, 726.94],
        [452.11, 832.93],
        [288.15, 922.92]
    ];

    // Function to add water droplet markers
    function addHoseMarkers() {
        hoseLocations.forEach(location => {
            const icon = L.divIcon({
                html: '<span class="material-icons water-droplet">water_drop</span>',
                className: 'water-droplet-marker',
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });
            
            L.marker(location, { icon }).addTo(map);
        });
    }

    // Coordinate clicking functionality - disabled
    /*
    let coordinateMode = false;
    const coordDisplay = document.getElementById('coordinate-display');
    const coordToggle = document.getElementById('coordinate-toggle');

    coordToggle.addEventListener('click', () => {
        coordinateMode = !coordinateMode;
        coordDisplay.style.display = coordinateMode ? 'block' : 'none';
        coordToggle.style.backgroundColor = coordinateMode ? '#e3f2fd' : 'white';
    });

    map.on('click', (e) => {
        if (coordinateMode) {
            const coords = [e.latlng.lat, e.latlng.lng];
            console.log(`[${coords[0]}, ${coords[1]}]`);
            coordDisplay.textContent = `Coordinates: [${coords[0].toFixed(2)}, ${coords[1].toFixed(2)}]`;
        }
    });
    */

    // Add hose markers when map is ready
    addHoseMarkers();
  } catch (error) {
    console.error("Error fetching trees:", error);
  }
});

// Bulk update function for tree dates
async function bulkUpdateTreeDates() {
  try {
    const treesSnapshot = await getDocs(collection(db, "trees"));
    let updateCount = 0;
    const totalTrees = treesSnapshot.size;
    
    const plantedDate = Timestamp.fromDate(new Date('2025-01-20'));
    const wateredDate = Timestamp.fromDate(new Date('2025-05-07'));
    
    console.log(`Starting bulk update of ${totalTrees} trees...`);
    
    for (const treeDoc of treesSnapshot.docs) {
      try {
        await updateDoc(doc(db, "trees", treeDoc.id), {
          datePlanted: plantedDate,
          lastWateredDate: wateredDate
        });
        updateCount++;
        console.log(`Updated tree ${updateCount}/${totalTrees}: ${treeDoc.id}`);
      } catch (error) {
        console.error(`Failed to update tree ${treeDoc.id}:`, error);
      }
    }
    
    console.log(`Bulk update complete. Successfully updated ${updateCount}/${totalTrees} trees.`);
  } catch (error) {
    console.error("Error in bulk update:", error);
  }
}

// Make the function available in the global scope for console access
window.bulkUpdateTreeDates = bulkUpdateTreeDates;

// Add cookie management functions
window.toggleGroveTree = function(treeId, buttonElement) {
    const btn = buttonElement || document.getElementById(`grove-btn-${treeId}`);
    const icon = btn.querySelector('.material-icons');
    const marker = window.treeMarkers.get(treeId);
    let myGrove = window.getMyGrove();
    
    if (myGrove.includes(treeId)) {
        // Remove from grove
        myGrove = myGrove.filter(id => id !== treeId);
        icon.textContent = 'favorite_border';
        icon.style.color = '#4CAF50';
        if (marker) {
            marker.getElement().classList.remove('favorited');
            // Remove any existing halo
            map.eachLayer((layer) => {
                if (layer.options.className === 'favorite-halo' && 
                    layer.getLatLng().lat === marker.getLatLng().lat && 
                    layer.getLatLng().lng === marker.getLatLng().lng) {
                    map.removeLayer(layer);
                }
            });
        }
    } else {
        // Add to grove
        myGrove.push(treeId);
        icon.textContent = 'favorite';
        icon.style.color = '#e53935';
        if (marker) {
            marker.getElement().classList.add('favorited');
            const latlng = marker.getLatLng();
            // Add yellow circle behind the tree marker
            L.circleMarker(latlng, {
                radius: 14,
                color: 'rgba(255, 215, 0, 0.6)',
                weight: 5,
                fillOpacity: 0,
                className: 'favorite-halo',
                interactive: false,
                pane: 'markerPane'  // Ensure proper layering
            }).addTo(map);
        }
    }
    
    // Save to cookie
    document.cookie = `myGrove=${JSON.stringify(myGrove)}; max-age=31536000; path=/`;

    // Close the popup after a short delay
    setTimeout(() => {
        if (marker) {
            marker.closePopup();
        }
    }, 300);
}
</script>
</body>
</html>